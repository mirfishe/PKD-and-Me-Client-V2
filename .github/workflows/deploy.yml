# * This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node.
# * For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs
# * FTP Deploy from: https://github.com/SamKirkland/FTP-Deploy-Action -- 10/04/2022 MF
# * About the CI environment variable: https://stackoverflow.com/questions/62663451/treating-warnings-as-errors-because-process-env-ci-true-failed-to-compile -- 10/04/2022 MF
# * Adding the .env property doesn't seem to work so that warnings aren't treated as errors. -- 10/10/2022 MF

name: Deploy PKD And Me Development

on:
  pull_request:
    types:
      - closed
    branches: [ "develop" ]

env:
  CI: false

jobs:
  build:

    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16.x]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}

    - name: Cache dependencies
      uses: actions/cache@v2
      with:
        path: |
          **/node_modules
        key: ${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}

    - name: Install dependencies
      run: npm install

    - name: Build
      run: |
        npm run continuousintegrationbuild --if-present

    - name: FTP Deploy - PKD And Me
      uses: SamKirkland/FTP-Deploy-Action@4.3.0
      with:
        # * ftp server
        server: 209.97.152.234
        # * ftp username
        username: ${{ secrets.ftpusername }}
        # * ftp password
        password: ${{ secrets.ftppassword }}
        # * Server port to connect to (read your web hosts docs)
        port: 22
        # * protocol to deploy with - ftp, ftps, or ftps-legacy
        protocol: ftps
        # * Folder to upload from, must end with trailing slash /
        local-dir: ./build/
        # * Path to upload to on the server. Must end with trailing slash /
        server-dir: /var/www/html/pkd-and-me/
        # * Path and name of the state file - this file is used to track which files have been deployed
        # state-name: # optional
        # * Prints which modifications will be made with current config options, but doesn't actually make any changes
        # dry-run: # optional
        # * Deletes ALL contents of server-dir, even items in excluded with exclude argument
        # dangerous-clean-slate: # optional
        # * An array of glob patterns, these files will not be included in the publish/delete process
        # exclude: # optional
        # * How verbose should the information be - minimal, standard, or verbose
        log-level: verbose
        # * strict or loose
        security: loose
